<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stego Image Decryptor</title>
<style>
body {
  background: #0d1117; color: #ffffff;
  font-family: "Poppins", sans-serif;
  display: flex; flex-direction: column;
  align-items: center; padding: 40px;
}
.container {
  background: #161b22; border-radius: 20px;
  padding: 30px; width: 420px;
  box-shadow: 0 0 15px #333; text-align: center;
}
input, button {
  margin: 10px; padding: 10px;
  width: 90%; border-radius: 8px; border: none;
}
button {
  background: #238636; color: white;
  cursor: pointer; font-weight: 600;
  transition: 0.3s;
}
button:hover { background: #2ea043; }
#result {
  margin-top: 20px; word-wrap: break-word;
  background: #0d1117; border-radius: 10px;
  padding: 15px; font-family: monospace;
  text-align: left;
}
</style>
</head>
<body>
<div class="container">
  <h2>Stego Image Decryptor</h2>
  <input type="file" id="imageInput" accept="image/png, image/jpeg">
  <input type="number" id="rails" placeholder="Enter number of rails">
  <button onclick="decodeImage()">Extract & Decrypt</button>
  <div id="result"></div>
</div>

<script>
function railFenceDecrypt(cipher, rails) {
  if (rails === 1) return cipher;
  const n = cipher.length;
  const rail = Array.from({ length: rails }, () => Array(n).fill('\n'));
  let dir_down = false, row = 0, col = 0;
  for (let i = 0; i < n; i++) {
    if (row === 0) dir_down = true;
    if (row === rails - 1) dir_down = false;
    rail[row][col++] = '*';
    row += dir_down ? 1 : -1;
  }
  let index = 0;
  for (let i = 0; i < rails; i++) {
    for (let j = 0; j < n; j++) {
      if (rail[i][j] === '*' && index < n) {
        rail[i][j] = cipher[index++];
      }
    }
  }
  let result = '';
  row = col = 0;
  for (let i = 0; i < n; i++) {
    if (row === 0) dir_down = true;
    if (row === rails - 1) dir_down = false;
    if (rail[row][col] !== '\n') result += rail[row][col++];
    row += dir_down ? 1 : -1;
  }
  return result;
}

function decodeImage() {
  const fileInput = document.getElementById('imageInput');
  const rails = parseInt(document.getElementById('rails').value);
  const resultDiv = document.getElementById('result');
  if (!fileInput.files[0] || !rails) {
    alert("Please select an image and enter the number of rails!");
    return;
  }
  const reader = new FileReader();
  reader.onload = function(event) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      try {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let binary = '';
        for (let i = 0; i < imageData.length; i += 4) {
          binary += (imageData[i] & 1);
        }
        const bytes = binary.match(/.{1,8}/g);
        let text = '';
        for (let byte of bytes) {
          const char = String.fromCharCode(parseInt(byte, 2));
          text += char;
          if (text.includes('§§')) break;
        }
        if (!text.includes('§§')) {
          resultDiv.innerHTML = "<b style='color:red'>No hidden message found!</b>";
          return;
        }
        const cipher = text.replace('§§', '');
        const decrypted = railFenceDecrypt(cipher, rails);
        resultDiv.innerHTML = `
          <b>Extracted Ciphertext:</b><br>${cipher}<br><br>
          <b>Decrypted Message:</b><br><span style="color:#58a6ff">${decrypted}</span>
        `;
      } catch (err) {
        resultDiv.innerHTML = "<b style='color:red'>Error reading image data. Try using a PNG generated by the encryptor.</b>";
      }
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(fileInput.files[0]);
}
</script>
</body>
</html>
